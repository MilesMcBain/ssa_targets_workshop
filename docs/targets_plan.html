<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Working Smarter with {targets}</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./targets_plan.html">The {targets} plan</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Working Smarter with {targets}</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working Smarter With {targets}</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./typical_R_projects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Strengths and weaknesses of typical R project workflows</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pure_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pure Functions as units of work</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./targets_plan.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">The {targets} plan</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Debugging {targets} with new access panels</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./branching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Divide and conquer with branching</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./long_vs_wide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Long vs Wide processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Help</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./more.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">More</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./end.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The End</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="the-targets-plan" class="level1">
<h1>The {targets} plan</h1>
<p>As discussed in the last section, refactoring our project into a collection of functions is actually most of the work in converting a pipeline to use {targets}. The <code>run.R</code> we built already looks a lot like a {targets} ‘plan’.</p>
<p>It’s time we actually defined what a {targets} plan is. This can be a little confusing because there are two things that users might refer to as the ‘plan’:</p>
<ol type="1">
<li>A script file, by convention called <code>_targets.R</code>, that sits in the root folder of the project.</li>
</ol>
<ul>
<li>Sets up environment for the project’s targets. Loads packages, sources script files containing functions to be called. Sets global state: options, environment variables etc.</li>
<li>Returns, as its last object, a list of target objects.</li>
</ul>
<ol start="2" type="1">
<li>The list of target objects itself. This data structure is what is analysed to determine the dependency structure of the pipeline graph.</li>
</ol>
<p>So in classic R fashion, the definition of the computational graph is itself a data structure which can be manipulated to great metaprogramming effect. For example we can have targets that appear in the <code>_targets.R</code> as a single computational node, but are actually expanded out into several targets in the final returned object.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>In this workshop we’ll refer to the <code>_targets.R</code> file as the plan.</p>
</section>
<section id="lets-create-a-plan" class="level1">
<h1>Let’s create a plan</h1>
<p>Let’s jump into refactoring our <code>run.R</code> into a {targets} plan.</p>
<section id="refactoring-steps" class="level2">
<h2 class="anchored" data-anchor-id="refactoring-steps">Refactoring steps</h2>
<ol type="1">
<li>rename <code>run.R</code> to <code>_targets.R</code></li>
<li>add <code>library(targets)</code> and <code>library(tarcheypes)</code> to libraries</li>
</ol>
<ul>
<li><code>{tarchetypes}</code> is discussed in the next section</li>
</ul>
<ol start="3" type="1">
<li>replace <code>set.seed(2048)</code> with <code>tar_option_set(seed = 2048)</code></li>
<li>Refactor paths bindings of data files like:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>weather_data_path <span class="ot">&lt;-</span> <span class="st">"data/brisbane_weather.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_file</span>(weather_data_path, <span class="st">"data/brisbane_weather.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>Refactor each object binding like:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>object_name <span class="ot">&lt;-</span> <span class="fu">function_call</span>(arg1, arg2, arg3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  object_name,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">function_call</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    arg1,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    arg2,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    arg3</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>),</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Wrap all the output bindings and their function calls in a <code>list()</code></li>
</ol>
<ul>
<li>make sure there’s a comma separating each</li>
</ul>
<ol start="7" type="1">
<li>Replace <code>render("docs/report.Rmd")</code> with</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_render</span>(report, <span class="st">"docs/report.Rmd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li>Wrap each pipeline output in the report in <code>tar_read()</code>, e.g.:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_read</span>(gg_species_distribution_points)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="9" type="1">
<li>Replace the code to source all files in the R folder with <code>tar_source()</code></li>
</ol>
<p>Now we have a {targets} plan!</p>
<p>The completed refactor is available on the <a href="https://github.com/MilesMcBain/classic_r_project/tree/refactor2">‘refactor2’ branch of the R project</a>.</p>
</section>
</section>
<section id="tarchetypes-and-the-targetopia" class="level1">
<h1>{tarchetypes} and the Targetopia</h1>
<p><a href="https://github.com/ropensci/tarchetypes"><code>{tarchtypes}</code></a> is an addon package to <code>{targets}</code> also authored by Will Landau. It contains helpful additions that make expressing {targets} plans simpler and cleaner. It is part of the <a href="https://wlandau.github.io/targetopia/packages.html">‘Targetopia’</a> family of extensions for targets.</p>
<p>{targets} has been designed to allow users to create their own domain specific extensions, for example see <a href="https://github.com/njtierney/geotargets"><code>{geotargets}</code></a>.</p>
<p>In this refactor we use several <code>{tarchetypes}</code> functions:</p>
<ul>
<li><code>tar_file()</code> is a compact way to declare both input and output file targets.
<ul>
<li>These files will trigger targets that depend on them to be rebuilt if they change.</li>
</ul></li>
<li><code>tar_render()</code> is a way to declare an RMarkdown report target (Yes, there is a Quarto variant).
<ul>
<li>The R code in the report is analysed to discover dependencies on other targets.</li>
</ul></li>
</ul>
</section>
<section id="making-a-plan" class="level1">
<h1>‘Making a plan’</h1>
<p>Assuming:</p>
<ul>
<li>Our R session working directory is the to the project root, where <code>_targets.R</code> is</li>
<li>We have the <code>{targets}</code> package loaded in our R session</li>
</ul>
<p>We can build all targets in the plan by calling <code>tar_make()</code></p>
<p>If we do that now we should see a stream of messages appear in our R terminal like:</p>
<pre><code>...
● completed target species_classification_model_training_summary [53.591 seconds]
▶ dispatched target species_classification_model
● completed target species_classification_model [3.06 seconds]
▶ dispatched target species_model_validation_data
● completed target species_model_validation_data [0.253 seconds]
▶ dispatched target base_plot_model_roc_object
Setting levels: control = FALSE, case = TRUE
Setting direction: controls &lt; cases
● completed target base_plot_model_roc_object [0.005 seconds]
▶ dispatched target gg_species_class_accuracy_hexes
● completed target gg_species_class_accuracy_hexes [0.136 seconds]
▶ dispatched target report
● completed target report [4.148 seconds]
▶ ended pipeline [1.095 minutes]</code></pre>
<p>Immediately calling <code>tar_make()</code> again should show something different:</p>
<pre><code>✔ skipped target species_classification_model_training_summary
✔ skipped target species_classification_model
✔ skipped target species_model_validation_data
✔ skipped target base_plot_model_roc_object
✔ skipped target gg_species_class_accuracy_hexes
✔ skipped target report
✔ skipped pipeline [0.173 seconds]</code></pre>
<p>By default the plan is built in a separate R session! So only state created by running <code>_targets.R</code> is used. This avoids a whole class of bugs that arise due to running code interactively against stale state in the global environment.</p>
</section>
<section id="the-store" class="level1">
<h1>The Store</h1>
<p>When we ran the plan for the second time all our targets were ‘skipped’ because the {targets} framework determined it already had the output for them, since nothing had changed since first time we ran the plan.</p>
<p>The built version of every target in the plan is stored in a place referred to as the store. By default the store lives inside the <code>_targets</code> folder which {targets} creates the first time we call <code>tar_make()</code>, and then refers to on every subsequent run.</p>
<p>For our project, that folder looks like this now:</p>
<pre><code>_targets
├── meta
│&nbsp;&nbsp; ├── meta
│&nbsp;&nbsp; ├── process
│&nbsp;&nbsp; └── progress
├── objects
│&nbsp;&nbsp; ├── base_plot_model_roc_object
│&nbsp;&nbsp; ├── brisbane_river
│&nbsp;&nbsp; ├── gg_species_class_accuracy_hexes
│&nbsp;&nbsp; ├── gg_species_distribution_hexes
│&nbsp;&nbsp; ├── gg_species_distribution_months
│&nbsp;&nbsp; ├── gg_species_distribution_points
│&nbsp;&nbsp; ├── occurrences
│&nbsp;&nbsp; ├── occurrences_training_data
│&nbsp;&nbsp; ├── occurrences_weather_hexes
│&nbsp;&nbsp; ├── species_classification_model
│&nbsp;&nbsp; ├── species_classification_model_training_summary
│&nbsp;&nbsp; ├── species_model_validation_data
│&nbsp;&nbsp; ├── study_species
│&nbsp;&nbsp; └── test_train_split
└── user</code></pre>
<p><code>_targets/objects</code> contains the R objects returned from the functions that ran for each target. Each object is serialised to a file in Rds format, and labeled with the associated target’s name. The file format is configurable with the the <code>format</code> option of <code>tar_target()</code>. There are also format helpers available like <code>tarchetypes::tar_parquet</code>, which defines a target that will be serialised to parquet format.</p>
<p>There are some targets that are not present. File targets are stored only in the metadata.</p>
<p>We can get some interesting information from the metadata with <code>tar_meta()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_meta</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>seconds) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, format, seconds, bytes, warnings, error) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<colgroup>
<col style="width: 54%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">format</th>
<th style="text-align: right;">seconds</th>
<th style="text-align: right;">bytes</th>
<th style="text-align: left;">warnings</th>
<th style="text-align: left;">error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">species_classification_model_training_summary</td>
<td style="text-align: left;">rds</td>
<td style="text-align: right;">54.934</td>
<td style="text-align: right;">395</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">occurrences</td>
<td style="text-align: left;">rds</td>
<td style="text-align: right;">9.832</td>
<td style="text-align: right;">326259</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">report</td>
<td style="text-align: left;">file</td>
<td style="text-align: right;">4.148</td>
<td style="text-align: right;">1950959</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">species_classification_model</td>
<td style="text-align: left;">rds</td>
<td style="text-align: right;">2.967</td>
<td style="text-align: right;">7969385</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">occurrences_weather_hexes</td>
<td style="text-align: left;">rds</td>
<td style="text-align: right;">0.488</td>
<td style="text-align: right;">511859</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">study_species</td>
<td style="text-align: left;">rds</td>
<td style="text-align: right;">0.347</td>
<td style="text-align: right;">555</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
<p>Targets can be read from the store like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a> species_classification_model_training_summary <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tar_read</span>(species_classification_model_training_summary) <span class="co"># returns value</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(species_classification_model_training_summary) <span class="co"># adds to global environment</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>This is very useful to inspect intermediate targets to do further development with, or debug the plan.</li>
</ul>
</section>
<section id="cleaning-the-store" class="level1">
<h1>Cleaning the store</h1>
<ul>
<li>Running <code>tar_invalidate(occurrences)</code> means the next time the plan is run <code>occurrences</code> will be rebuilt, which MAY trigger downstream targets to be rebuilt, but not necessarily if targets identifies the value hasn’t changed. The stored value and metadata is retained.</li>
<li><code>tar_delete()</code> removes targets from the store. It supports ‘tidyselect’ style name matching.
<ul>
<li><code>tar_delete(everything())</code> wipes the whole store.</li>
</ul></li>
<li><code>tar_prune()</code> removes historical targets from the store that are no longer in the plan.
<ul>
<li>Useful if you accidentally get a typo’d version of target in your store and keep loading it by accident.</li>
</ul></li>
</ul>
</section>
<section id="plan-visualisation" class="level1">
<h1>Plan visualisation</h1>
<p>The graph of targets defined in the plan can be visualised with either - <code>tar_visnetwork()</code> - <code>tar_glimpse()</code> - doesn’t show information about which targets are up to date</p>
<p>e.g.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/targets_visnetwork2.png" class="img-fluid figure-img"></p>
<figcaption>The result of tar_visnetwork() on our project.</figcaption>
</figure>
</div>
<p>These get messy fast, but one useful aspect is targets that align vertically are not dependent on each other, so it can help you understand the scope for parallelisation to speed up running the plan.</p>
</section>
<section id="finer-points" class="level1">
<h1>Finer points</h1>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>The global environment established by the <code>_targets.R</code> is used to evaluate all targets. This includes loaded packages. In the case of parallelism, as we will see later, the environment is replicated.</p>
<p>Aside from the traditional <code>library()</code> method, there is another way to declare packages, per target, using the <code>packages</code> argument. In this case the packages are loaded right before the target is built, or it’s built object is used in a downstream target. This may be situationally convenient, but because targets that do not share a dependency relationship can be run in any order, this means that packages can be loaded in any order, which could have unexpected consequences. I would suggest avoiding this.</p>
<p>Many examples you see will set packages globally in <code>_targets.R</code> using <code>tar_option_set(packages = )</code> this conveys no advantage over the <code>library()</code> method, and has one significant drawback in that <code>renv</code> will not detect these packages automatically as project dependencies.</p>
<p>My recommendation is to stick with <code>library()</code></p>
<p>There is one other option related to packages which is important. <code>tar_option_set(imports = )</code> defines a set of packages whose functions and objects are to be watched for changes. If the package is updated it will cause dependent targets that use updated functions or objects to be rebuilt.</p>
<p>You probably don’t want to put every package in here - scanning through large amounts of code slows things down - packages that updated regularly could trigger too much churn in your pipeline - your internal packages or quite unstable packages are probably good candidates.</p>
</section>
<section id="constants" class="level2">
<h2 class="anchored" data-anchor-id="constants">Constants</h2>
<p>At the moment we have a objects declared outside the plan. E.g. <code>study_date &lt;- ymd("2024-05-08")</code>. These are still watched for changes, but they are not targets. Their value is not available from the store. My advice is that it makes for a slightly better interactive development and debugging workflows to have them in the list of targets objects, so they become fully fledged targets, and available from the store.</p>
<p><code>tarchetypes::tar_plan</code> is a replacement for <code>list()</code>allows targets to be written in the list like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_plan</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">study_date =</span> <span class="fu">ymd</span>(<span class="st">"2024-05-08"</span>),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    study_species,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">search_taxa</span>(<span class="fu">c</span>(<span class="st">"Threskiornis molucca"</span>, <span class="st">"Threskiornis spinicollis"</span>))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="file-targets" class="level2">
<h2 class="anchored" data-anchor-id="file-targets">File targets</h2>
<p>It can be confusing that both input files and output files are declared the same way.</p>
<ul>
<li>If you have a file input, and you need targets that depend on the file to be rebuilt if the file changes, use <code>tar_file()</code> in your plan.</li>
<li>If you have a target that writes a file, and you want that target to be rebuilt (and file rewritten), if the file is removed, use <code>tar_file()</code> in your plan.</li>
</ul>
<p>Just remember <code>tar_file()</code> for files!</p>
</section>
</section>
<section id="interactive-development-workflow" class="level1">
<h1>Interactive development workflow</h1>
<p>Here I’ll give you a quick demo of how you proceed with development.</p>
<p>The main elements are:</p>
<ol type="1">
<li><code>tar_load()</code> the targets you want to work with interactively from the targets store with <code>tar_load()</code> - There is an RStuido Addin that ships with targets that can load the target under the cursor from the store. It is highly recommended that you make a keyboard shortcut for this. See <a href="https://docs.posit.co/ide/user/ide/guide/productivity/add-ins.html#keyboard-shortcuts">creating a keyboard shortcuts for RStudio addins</a></li>
<li>Declare a new target, and create a new function to be home to your work. - Don’t forget about <code>{fnmate}</code>!</li>
<li>Once your function seems like it will work, immediately run <code>tar_make()</code> - I also highly advise making a keyboard shortcut for this. - It’s also convenient to run <code>tar_make(target_name)</code> to run the pipeline up to, but not past, the target you built, if there are other unrelated targets you don’t want to run right now.</li>
<li>Repeat. (e.g.&nbsp;<code>tar_load()</code> the target you just defined and built to do further work)</li>
</ol>
<p>Sometimes people ask about where to put experimental code they’re not sure should be in the plan yet. At the bottom of a file I’m working with I sometimes keep a ‘scratchpad’ of related code inside a block like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(){</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># experimental code goes here</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code is not run when running the plan and since the function has no name, it cannot be accidentally called. This tip came from Gábor Csárdi.</p>
</section>
<section id="review" class="level1">
<h1>Review</h1>
<p>What does each of these functions do?</p>
<ul>
<li><code>tar_make()</code></li>
<li><code>tar_load()</code></li>
<li><code>tar_meta()</code></li>
<li><code>tar_invalidate()</code></li>
<li><code>tar_delete()</code></li>
<li><code>tar_target()</code></li>
<li><code>tar_file()</code></li>
<li><code>tar_render()</code></li>
</ul>
<p>What must be the last object returned in the <code>_targets.R</code>?</p>
<p>If you can answer those, you now have enough tools to use targets productively on your projects. The cake is baked. It’s all icing from here.</p>
</section>
<section id="the-two-kinds-of-reproducibility" class="level1">
<h1>The two kinds of reproducibility</h1>
<p>Hopefully you can see how the plan we have now defeats classes reproducibility issues typically experienced with classic R projects. Explicitly, we get a more reproducible workflow since:</p>
<ul>
<li>Our targets are built in a separate session, so cannot be affected the by the state of our interactive development environment.</li>
<li>Since <code>{targets}</code> intelligently caches our work, we can frequently run the pipeline with the same reproducibility guarantees as if we were running it from scratch, but take a fraction of the time.
<ul>
<li>Avoids the situation where the pipeline is rarely run end to end after small changes.</li>
</ul></li>
</ul>
<p>There is a second kind or reproducibility supported by this workflow though. I’ll argue with <code>{targets}</code> we can more easily reproduce an understanding of what all this code is doing in someone else’s head.</p>
<p>Imagine you are tasked with peer-reviewing a pipeline. If that pipeline is engineered with <code>{targets}</code> your workflow looks like:</p>
<ol type="1">
<li>Run the full pipeline with <code>tar_make()</code>. - Barring issues with the package dependencies, the code just works! It has frequently been tested end-to-end.</li>
<li>You start your review form the <code>_targets.R</code> which gives you a nice overview of what the important bits of information the pipeline depends on are. - You might even run <code>tar_visnetwork()</code> To get a feel for the most important chains of targets.</li>
<li>When you decide you need to inspect the code for a target to understand it better, you can immediately: - <code>tar_load()</code> the input targets from the store, and execute a ‘jump to definition’ to go directly to the code where those targets are used. You can interactively play with the code until it makes sense.</li>
<li>You can context switch away and come back, maybe days later, and do exactly the same thing. All the pipeline’s targets are still sitting in the store ready for immediate interactive use.</li>
</ol>
<p>For similar reasons as described here, <code>{targets}</code> works very well to support teams that have a high degree of context switching.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>More concretely: We could have a ‘model fit’ target that decomposes into two separate targets for the model and performance statistics. We could use an argument to change the assessment criteria without rebuilding the model. Don’t worry if that didn’t make sense yet.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>